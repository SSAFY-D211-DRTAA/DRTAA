# Step 1: ROS Noetic을 포함한 기본 이미지 설정
FROM ros:noetic-ros-core-focal

# Step 2: 필수 패키지 및 빌드 도구 설치
RUN apt-get update && apt-get install -y \
    ros-noetic-rosbridge-suite \
    python3-catkin-tools \
    build-essential \
    cmake \
    git \
    && rm -rf /var/lib/apt/lists/*

# Step 3: 작업 디렉토리 설정
WORKDIR /root/catkin_ws

# Step 4: catkin workspace 디렉토리 및 src 생성
RUN mkdir -p /root/catkin_ws/src

# Step 5: MORAI ROS 메시지 패키지 클론
RUN git clone https://github.com/MORAI-Autonomous/MORAI-ROS_morai_msgs.git /root/catkin_ws/src/MORAI-ROS_morai_msgs

# Step 6: catkin workspace 빌드
RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && cd /root/catkin_ws && catkin_make"

# Step 7: 환경 설정을 위한 setup.bash 소스 추가
RUN echo "source /root/catkin_ws/devel/setup.bash" >> ~/.bashrc

# Step 8: rosbridge_server 실행을 위한 환경 설정
ENV ROS_MASTER_URI=http://localhost:11311
ENV ROS_PACKAGE_PATH=/opt/ros/noetic/share

# Step 9: rosbridge_server 실행을 위한 entrypoint 설정
CMD ["bash", "-c", "source /root/catkin_ws/devel/setup.bash && roslaunch rosbridge_server rosbridge_websocket.launch"]
